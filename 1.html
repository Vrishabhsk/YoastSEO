<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      .flex {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .short-flex {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .narrow-flex {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      #insights {
        margin-bottom: 30px;
      }

      body {
        padding: 0 10px;
        font-family: Arial, sans-serif;
      }

      .yoast-result {
        margin: 12px 0;
      }

      /* Accordion styles */
      .accordion-section {
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .accordion-header {
        background-color: #f1f1f1;
        padding: 10px;
        cursor: pointer;
        user-select: none;
      }

      .accordion-header::after {
        content: '\002B';
        float: right;
        font-weight: bold;
      }

      .accordion-header.active::after {
        content: '\2212';
      }

      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
      }
    </style>
  </head>
  <body>
    <h1>Yoast SEO</h1>
    <form id="yoast-focus-keyphrase">
      <label>Focus Keyphrase</label>
      <br />
      <input type="text" name="focusKeyphrase" />
      <p>Use the main word or phrase that you want your content to rank for in search engines.</p>
      <button type="button">Get related keyphrases</button>
    </form>
    <div class="accordion-section">
      <div class="accordion-header">SEO Analysis</div>
      <div class="accordion-content" id="seo-analysis-content"></div>
    </div>
    <div class="accordion-section">
      <div class="accordion-header">Readability Analysis</div>
      <div class="accordion-content" id="readability-analysis-content"></div>
    </div>
    <div class="accordion-section">
      <div class="accordion-header">Insights</div>
      <div class="accordion-content">
        <h3>Prominent Words</h3>
        <p>Once you add a bit more copy, we'll give you a list of words that occur the most in the content</p>
        <hr />
        <h3>Flesch reading ease</h3>
        <div class="flex">
          <span id="yoast-flesch-reading">?/100</span>
        </div>
        <hr />
        <div class="flex">
          <div>
            <h3>Reading Time</h3>
            <div class="narrow-flex"><span id="yoast-reading-time"></span> minutes</div>
          </div>
          <div>
            <h3>Word Count</h3>
            <div class="narrow-flex"><span id="yoast-word-count"></span> words</div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const analyseDocument = async (data) => {
      const reqHeaders = new Headers();
      reqHeaders.append("Content-Type", "application/json");

      const response = await fetch( 'https://union-pulling-minnesota-tasks.trycloudflare.com/yoast-analysis', {
        method: "POST",
        headers: reqHeaders,
        cache: "no-cache",
        body: JSON.stringify(data)
      });

      const res = await response.json();

      const {readability, seo, wordCount, readingTime, fleschReadingScore} = res.data;

      // calculate readability score
      const readabilityElements = [];
      readability.forEach((result, idx) => {
        let color = '';
        if ( result.score < 0 ) {
          color = "red";
        }
        if (result.score <= 4) {
          color = "lightcoral";
        }
        if (result.score > 4 && result.score < 8) {
          color = "orange";
        }
        if ( result.score > 7 ) {
          color = "green";
        }
        readabilityElements.push({
          score: result.score,
          type: color,
          text: result.text
        })
      })

      const readabilityContainer = document.querySelector('#readability-analysis-content');
      readabilityElements.forEach((item) => {
        const element = document.createElement('div');
        const indicator = document.createElement('span');
        indicator.setAttribute('style', `background-color: ${item.type}; border-radius: 50%; color: #000; padding: 10px`);
        element.append(indicator);
        element.innerHTML += `<p>${item.text}</p>`;
        element.setAttribute('class', 'short-flex yoast-result');
        readabilityContainer.append(element);
      });

      const seoElements = [];
      seo.forEach((result, idx) => {
        let color = '';
        if ( result.score < 0 ) {
          color = "red";
        }
        if (result.score <= 4) {
          color = "lightcoral";
        }
        if (result.score > 4 && result.score < 8) {
          color = "orange";
        }
        if ( result.score > 7 ) {
          color = "green";
        }
        seoElements.push({
          score: result.score,
          type: color,
          text: result.text
        })
      })

      const seoContainer = document.querySelector('#seo-analysis-content');
      seoElements.forEach((item) => {
        const element = document.createElement('div');
        const indicator = document.createElement('span');
        indicator.setAttribute('style', `background-color: ${item.type}; border-radius: 50%; color: #000; padding: 10px`);
        element.append(indicator);
        element.innerHTML += `<p>${item.text}</p>`;
        element.setAttribute('class', 'short-flex yoast-result');
        seoContainer.append(element);
      });

      const readingTimeEl = document.querySelector("#yoast-reading-time");
      readingTimeEl.innerHTML = readingTime;

      const wordCountEl = document.querySelector("#yoast-word-count")
      wordCountEl.innerHTML = wordCount;

      const fleschReadingEl = document.querySelector("#yoast-flesch-reading");
      fleschReadingEl.innerHTML = `${fleschReadingScore?.score}/100`
    }

    function onSuccess(data) {
      const content = <?= getDocumentHTML() ?>;
      analyseDocument({
        content: JSON.stringify(content),
        title: data.contentTitle
      })
    }

    function retreiveData() {
      google.script.run.withSuccessHandler(onSuccess).getData();
    };

    setTimeout(() => {
      retreiveData();
    }, 2000);

    // Accordion functionality
    const accordionHeaders = document.querySelectorAll('.accordion-header');

    accordionHeaders.forEach(header => {
      header.addEventListener('click', () => {
        header.classList.toggle('active');
        const content = header.nextElementSibling;
        if (content.style.maxHeight) {
          content.style.maxHeight = null;
        } else {
          content.style.maxHeight = content.scrollHeight + "px";
        }
      });
    });
  </script>
</html>
